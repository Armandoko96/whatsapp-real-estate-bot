# ü§ñ GEMINI AI INTEGRATION COMPLETA

## üîë API KEY Y CONFIGURACI√ìN

### VARIABLES DE ENTORNO:
```env
GEMINI_API_KEY=AIzaSyC-abc123def456ghi789jkl012mno345pqr678
```

### INICIALIZACI√ìN GEMINI SERVICE:
```typescript
import { GoogleGenerativeAI } from '@google/generative-ai';

export class GeminiService {
  private genAI: GoogleGenerativeAI;
  private model: any;

  constructor() {
    try {
      const apiKey = process.env.GEMINI_API_KEY;
      if (!apiKey) {
        throw new Error('GEMINI_API_KEY no configurada');
      }

      this.genAI = new GoogleGenerativeAI(apiKey);
      this.model = this.genAI.getGenerativeModel({ 
        model: "gemini-1.5-flash" 
      });
      
      console.log('‚úÖ Gemini AI inicializado correctamente');
    } catch (error) {
      console.error('‚ùå Error inicializando Gemini:', error);
      throw error;
    }
  }

  // Analizar propiedad desde texto
  async analyzePropertyText(text: string, routeInfo: any): Promise<any> {
    try {
      const prompt = `
Analiza la siguiente informaci√≥n de propiedad inmobiliaria y extrae los datos estructurados.

CONTEXTO:
- Agente: ${routeInfo.agent}
- Tipo: ${routeInfo.type} 
- Operaci√≥n: ${routeInfo.operation}
- Sector: ${routeInfo.sector}

TEXTO A ANALIZAR:
"${text}"

INSTRUCCIONES:
Extrae y estructura la siguiente informaci√≥n en formato JSON:

{
  "precio": "precio encontrado o 'No especificado'",
  "superficie": "metros cuadrados o 'No especificado'",
  "habitaciones": "n√∫mero de habitaciones o 0",
  "ba√±os": "n√∫mero de ba√±os o 0", 
  "estacionamientos": "n√∫mero de estacionamientos o 0",
  "ubicacion": {
    "calle": "calle espec√≠fica o ''",
    "colonia": "colonia/fraccionamiento o ''",
    "ciudad": "ciudad o 'Culiac√°n'",
    "referencias": "referencias adicionales o ''"
  },
  "caracteristicas": ["lista", "de", "caracter√≠sticas", "especiales"],
  "descripcion": "descripci√≥n limpia y profesional",
  "contacto": {
    "telefono": "n√∫mero si se menciona o ''",
    "email": "email si se menciona o ''"
  },
  "confianza": 0.85
}

Responde SOLO con el JSON, sin texto adicional.
`;

      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      const analysisText = response.text();
      
      // Limpiar y parsear JSON
      const cleanJson = analysisText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      const analysis = JSON.parse(cleanJson);
      
      console.log('‚úÖ An√°lisis de texto completado');
      return analysis;
      
    } catch (error) {
      console.error('‚ùå Error analizando texto:', error);
      return this.getDefaultAnalysis();
    }
  }

  // Analizar im√°genes de propiedades
  async analyzePropertyImages(imageBuffers: Buffer[], routeInfo: any): Promise<any> {
    try {
      const prompt = `
Analiza estas im√°genes de una propiedad inmobiliaria y extrae informaci√≥n visual.

CONTEXTO:
- Agente: ${routeInfo.agent}
- Tipo: ${routeInfo.type}
- Operaci√≥n: ${routeInfo.operation} 
- Sector: ${routeInfo.sector}

INSTRUCCIONES:
Analiza las im√°genes y extrae en formato JSON:

{
  "espacios_identificados": ["cocina", "sala", "habitaci√≥n", "etc"],
  "estado_propiedad": "excelente|bueno|regular|requiere_reparaciones",
  "estilo_arquitectonico": "moderno|tradicional|colonial|etc",
  "elementos_destacados": ["lista", "de", "elementos", "visibles"],
  "condiciones_visibles": ["nueva", "usada", "remodelada", "etc"],
  "estimacion_visual": {
    "habitaciones_aparentes": 2,
    "ba√±os_visibles": 1,
    "tiene_cochera": true,
    "tiene_jardin": false
  },
  "calidad_imagenes": "alta|media|baja",
  "recomendaciones_foto": ["mejor", "iluminaci√≥n", "etc"],
  "confianza_analisis": 0.75
}

Responde SOLO con el JSON.
`;

      // Convertir buffers a base64 para Gemini
      const imageParts = imageBuffers.map(buffer => ({
        inlineData: {
          data: buffer.toString('base64'),
          mimeType: "image/jpeg"
        }
      }));

      const result = await this.model.generateContent([prompt, ...imageParts]);
      const response = await result.response;
      const analysisText = response.text();
      
      const cleanJson = analysisText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      const analysis = JSON.parse(cleanJson);
      
      console.log('‚úÖ An√°lisis de im√°genes completado');
      return analysis;
      
    } catch (error) {
      console.error('‚ùå Error analizando im√°genes:', error);
      return this.getDefaultImageAnalysis();
    }
  }

  // Generar descripci√≥n profesional
  async generatePropertyDescription(textAnalysis: any, imageAnalysis: any, routeInfo: any): Promise<string> {
    try {
      const prompt = `
Genera una descripci√≥n profesional para una propiedad inmobiliaria.

INFORMACI√ìN EXTRA√çDA:
An√°lisis de texto: ${JSON.stringify(textAnalysis, null, 2)}
An√°lisis de im√°genes: ${JSON.stringify(imageAnalysis, null, 2)}
Ruta: ${routeInfo.agent} - ${routeInfo.type} - ${routeInfo.operation} - ${routeInfo.sector}

INSTRUCCIONES:
Genera una descripci√≥n profesional que incluya:
1. Encabezado atractivo
2. Caracter√≠sticas principales
3. Ubicaci√≥n y sector
4. Detalles t√©cnicos
5. Call to action

Estilo: Profesional pero atractivo, m√°ximo 300 palabras.
Tono: Persuasivo pero honesto.

Responde solo con la descripci√≥n, sin formato adicional.
`;

      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      const description = response.text().trim();
      
      console.log('‚úÖ Descripci√≥n generada');
      return description;
      
    } catch (error) {
      console.error('‚ùå Error generando descripci√≥n:', error);
      return this.getDefaultDescription(routeInfo);
    }
  }

  // An√°lisis completo (texto + im√°genes)
  async analyzeCompleteProperty(text: string, imageBuffers: Buffer[], routeInfo: any): Promise<any> {
    try {
      console.log('ü§ñ Iniciando an√°lisis completo con Gemini...');
      
      // An√°lisis paralelo
      const [textAnalysis, imageAnalysis] = await Promise.all([
        this.analyzePropertyText(text, routeInfo),
        imageBuffers.length > 0 ? this.analyzePropertyImages(imageBuffers, routeInfo) : null
      ]);

      // Generar descripci√≥n profesional
      const description = await this.generatePropertyDescription(textAnalysis, imageAnalysis, routeInfo);

      const completeAnalysis = {
        textAnalysis,
        imageAnalysis,
        generatedDescription: description,
        processedAt: new Date().toISOString(),
        confidence: this.calculateOverallConfidence(textAnalysis, imageAnalysis)
      };

      console.log('‚úÖ An√°lisis completo finalizado');
      return completeAnalysis;
      
    } catch (error) {
      console.error('‚ùå Error en an√°lisis completo:', error);
      throw error;
    }
  }

  // M√©todos auxiliares
  private getDefaultAnalysis(): any {
    return {
      precio: "No especificado",
      superficie: "No especificado", 
      habitaciones: 0,
      ba√±os: 0,
      estacionamientos: 0,
      ubicacion: {
        calle: "",
        colonia: "",
        ciudad: "Culiac√°n",
        referencias: ""
      },
      caracteristicas: [],
      descripcion: "Informaci√≥n pendiente de an√°lisis",
      contacto: {
        telefono: "",
        email: ""
      },
      confianza: 0.1
    };
  }

  private getDefaultImageAnalysis(): any {
    return {
      espacios_identificados: [],
      estado_propiedad: "no_determinado",
      estilo_arquitectonico: "no_determinado",
      elementos_destacados: [],
      condiciones_visibles: [],
      estimacion_visual: {
        habitaciones_aparentes: 0,
        ba√±os_visibles: 0,
        tiene_cochera: false,
        tiene_jardin: false
      },
      calidad_imagenes: "no_evaluada",
      recomendaciones_foto: [],
      confianza_analisis: 0.1
    };
  }

  private getDefaultDescription(routeInfo: any): string {
    return `Propiedad disponible en ${routeInfo.sector} a trav√©s de ${routeInfo.agent}. 
${routeInfo.operation === 'Rentas' ? 'En renta' : 'En venta'} por ${routeInfo.type.toLowerCase()}. 
Cont√°ctanos para m√°s informaci√≥n y programar una visita.`;
  }

  private calculateOverallConfidence(textAnalysis: any, imageAnalysis: any): number {
    const textConf = textAnalysis?.confianza || 0;
    const imageConf = imageAnalysis?.confianza_analisis || 0;
    
    if (imageAnalysis) {
      return (textConf + imageConf) / 2;
    }
    return textConf;
  }
}
```

## üîó INTEGRACI√ìN CON SERVER.TS

### INICIALIZACI√ìN:
```typescript
import { GeminiService } from './services/geminiService';

const geminiService = new GeminiService();
```

### USO EN FLUJO DE IM√ÅGENES:
```typescript
// Cuando el usuario termina de enviar im√°genes
async function finalizePropertyAnalysis(fromNumber: string, userSession: any) {
  try {
    console.log('ü§ñ Iniciando an√°lisis con Gemini...');
    
    // Obtener im√°genes descargadas
    const imageBuffers = await getStoredImages(userSession.propertyId);
    
    // Analizar con Gemini
    const analysis = await geminiService.analyzeCompleteProperty(
      userSession.originalText || "",
      imageBuffers,
      userSession.currentRoute
    );
    
    // Guardar an√°lisis en Firebase
    await firebaseService.updateProperty(userSession.propertyId, {
      geminiAnalysis: analysis,
      status: 'analyzed'
    });
    
    // Generar documento final
    await documentService.generatePropertyDocument({
      propertyId: userSession.propertyId,
      analysis: analysis,
      route: userSession.currentRoute,
      images: userSession.imageFiles
    });
    
    // Respuesta al usuario
    await sendMessage(fromNumber, `‚úÖ An√°lisis completado para ${userSession.propertyId}

üìä AN√ÅLISIS INTELIGENTE:
${analysis.generatedDescription}

üìÅ Todos los archivos han sido organizados en Google Drive.
ü§ñ An√°lisis IA completado con ${Math.round(analysis.confidence * 100)}% de confianza.`);
    
  } catch (error) {
    console.error('‚ùå Error en an√°lisis final:', error);
    await sendMessage(fromNumber, 'Error completando el an√°lisis. Los archivos se guardaron correctamente.');
  }
}
```

## üéØ PROMPTS OPTIMIZADOS

### PARA AN√ÅLISIS DE TEXTO:
- **Contexto espec√≠fico** del tipo de propiedad
- **Extracci√≥n estructurada** en JSON
- **Campos obligatorios** con valores por defecto
- **Nivel de confianza** para cada extracci√≥n

### PARA AN√ÅLISIS DE IM√ÅGENES:
- **Identificaci√≥n de espacios** (cocina, ba√±o, habitaciones)
- **Estado de la propiedad** (nuevo, usado, etc.)
- **Elementos destacados** visualmente
- **Recomendaciones** para mejores fotos

### PARA DESCRIPCI√ìN FINAL:
- **Combina** an√°lisis de texto e imagen
- **Tono profesional** pero atractivo
- **Call to action** espec√≠fico por tipo de operaci√≥n
- **M√°ximo 300 palabras** para legibilidad

## ‚öôÔ∏è CONFIGURACI√ìN RAILWAY

```bash
# Variable de entorno
railway variables set GEMINI_API_KEY=AIzaSyC-abc123...

# Verificar en c√≥digo
console.log('Gemini API:', process.env.GEMINI_API_KEY ? 'Configurado ‚úÖ' : 'No configurado ‚ùå');
```

## üö® MANEJO DE ERRORES

### Rate Limiting:
```typescript
async analyzeWithRetry(prompt: string, maxRetries = 3): Promise<any> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await this.model.generateContent(prompt);
    } catch (error) {
      if (error.message.includes('quota') && attempt < maxRetries) {
        await this.delay(2000 * attempt); // Backoff exponencial
        continue;
      }
      throw error;
    }
  }
}
```

### Respuestas inv√°lidas:
```typescript
private validateAnalysis(analysis: any): boolean {
  return (
    analysis &&
    typeof analysis === 'object' &&
    'precio' in analysis &&
    'descripcion' in analysis
  );
}
```
